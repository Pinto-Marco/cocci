{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
                    {% if images %}
                        <div class="carousel-container">
                            <button class="nav-arrow left">‹</button>
                            <div class="carousel-track">
                                {% for image in images %}
                                    <div class="card" data-index="{{ forloop.counter0 }}">
                                        <img src="{{ image }}" alt="Product image number {{ forloop.counter0 }}">
                                    </div>
                                {% endfor %}
                            </div>
                            <button class="nav-arrow right">›</button>
                        </div>
                    {% else %}
                        <div class="carousel-item active">
                            <img src="https://via.placeholder.com/500x500.png?text=No+Image+Available" class="d-block w-100" alt="No image available">
                        </div>
                    {% endif %}
                    <div style="display: flex; flex-direction: row; width: 100%; border-top: 1px solid #000; border-bottom: 1px solid #000;">
                        <button class="nav-arrow left" style="border-right: none;">Place Order</button>
                        <button class="nav-arrow right" style="border-right: none;">Place Order</button>
                    </div>
    <div class="row">
        <div class="col-md-6">
            <!-- Product Details -->
            <h2>{{ product.title }}</h2>
            <p>{{ product.description }}</p>
            <p><strong>Price:</strong> ${{ product.price }}</p>
            
            <!-- Add to Cart Button -->
            <form method="post" action="{% url 'add-to-cart-api' %}">
                {% csrf_token %}
                <input type="hidden" name="product_code" value="{{ product.code }}">
                <button type="submit" class="btn btn-primary">Add to Cart</button>
            </form>
        </div>
    </div>
</div>

<script>

const cards = document.querySelectorAll(".card");
const dots = document.querySelectorAll(".dot");
const leftArrow = document.querySelector(".nav-arrow.left");
const rightArrow = document.querySelector(".nav-arrow.right");
let currentIndex = 0;
let isAnimating = false;
let totalImages = cards.length;

function updateCarousel(newIndex) {
	if (isAnimating) return;
	isAnimating = true;

	currentIndex = (newIndex + cards.length) % cards.length;

	cards.forEach((card, i) => {
		const offset = (i - currentIndex + cards.length) % cards.length;

		card.classList.remove(
			"center",
			"left-1",
			"left-2",
			"right-1",
			"right-2",
			"hidden"
		);

		if (offset === 0) {
			card.classList.add("center");
		} else if (offset === 1) {
			card.classList.add("right-1");
		} else if (offset === cards.length - 1) {
			card.classList.add("left-1");
		} else {
			card.classList.add("hidden");
		}
	});

	dots.forEach((dot, i) => {
		dot.classList.toggle("active", i === currentIndex);
	});

	setTimeout(() => {
		isAnimating = false;
	}, 800);
}

leftArrow.addEventListener("click", () => {
	updateCarousel(currentIndex - 1);
});

rightArrow.addEventListener("click", () => {
    if (currentIndex < totalImages) {
    	updateCarousel(currentIndex + 1);
    }
	
});

cards.forEach((card, i) => {
	card.addEventListener("click", () => {
		updateCarousel(i);
	});
});

document.addEventListener("keydown", (e) => {
	if (e.key === "ArrowLeft") {
		updateCarousel(currentIndex - 1);
	} else if (e.key === "ArrowRight") {
		updateCarousel(currentIndex + 1);
	}
});

let touchStartX = 0;
let touchEndX = 0;

document.addEventListener("touchstart", (e) => {
	touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener("touchend", (e) => {
	touchEndX = e.changedTouches[0].screenX;
	handleSwipe();
});

function handleSwipe() {
	const swipeThreshold = 50;
	const diff = touchStartX - touchEndX;

	if (Math.abs(diff) > swipeThreshold) {
		if (diff > 0) {
			updateCarousel(currentIndex + 1);
		} else {
			updateCarousel(currentIndex - 1);
		}
	}
}

updateCarousel(0);

</script>
{% endblock %}