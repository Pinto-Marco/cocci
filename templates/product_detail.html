{% extends 'base.html' %} {% block content %}
<div class="container mt-5">
  {% if images %}
  <div class="carousel-container">
    <div class="carousel-track">
      {% for image in images %}
      <div class="card" data-index="{{ forloop.counter0 }}">
        <img
          src="{{ image }}"
          alt="Product image number {{ forloop.counter0 }}"
        />
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="carousel-container-mobile">
    {% for image in images %}
    <div class="card-mobile" data-index="{{ forloop.counter0 }}">
      <img
        src="{{ image }}"
        alt="Product image number {{ forloop.counter0 }}"
      />
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="carousel-item active">
    <img
      src="https://via.placeholder.com/500x500.png?text=No+Image+Available"
      class="d-block w-100"
      alt="No image available"
    />
  </div>
  {% endif %}
  <div
    style="
      display: flex;
      flex-direction: row;
      width: 100%;
      border-top: 1px solid #000;
      border-bottom: 1px solid #000;
    "
  >
    <div class="controls">
      <button
        class="nav-arrow left checkout-btn"
        style="border-right: none; width: 100%"
      >
        Previous
      </button>
      <button class="nav-arrow right checkout-btn" style="border-right: none">
        Next
      </button>
    </div>
    <div class="controls-mobile">
      <button
        class="nav-arrow-mobile left checkout-btn"
        style="border-right: none"
      >
        Previous
      </button>
      <button
        class="nav-arrow-mobile right checkout-btn"
        style="border-right: none"
      >
        Next
      </button>
    </div>
  </div>
  <div style="margin: 2rem 3rem">
    <!-- Product Details -->
    <div
      style="
        display: flex;
        direction: ltr;
        justify-content: space-between;
        align-items: center;
      "
    >
      <h1>{{ product.title }}</h1>
      <h1>${{ product.price }}</h1>
    </div>
    <p style="font-size: larger">{{ product.description }}</p>
  </div>
  <button
    type="submit"
    class="checkout-btn product-details-add-to-cart"
    style="padding: 1rem; border-top: 1px solid #000"
    data-product-code="{{ product.code }}"
    data-csrf="{{ csrf_token }}"
	{% if not product.is_available %}disabled{% endif %}
  >
    {% if not product.is_available %}
    Out of Stock
    {% else %}
    Add To Cart
    {% endif %}
  </button>
</div>

<script>
  const cards = document.querySelectorAll(".card");
  const dots = document.querySelectorAll(".dot");
  const leftArrow = document.querySelector(".nav-arrow.left");
  const rightArrow = document.querySelector(".nav-arrow.right");
  let currentIndex = 0;
  let isAnimating = false;
  let totalImages = cards.length;

  function updateCarousel(newIndex) {
    if (isAnimating) return;
    isAnimating = true;

    currentIndex = (newIndex + cards.length) % cards.length;

    cards.forEach((card, i) => {
      const offset = (i - currentIndex + cards.length) % cards.length;

      card.classList.remove(
        "center",
        "left-1",
        "left-2",
        "right-1",
        "right-2",
        "hidden"
      );

      if (offset === 0) {
        card.classList.add("center");
      } else if (offset === 1) {
        card.classList.add("right-1");
      } else if (offset === cards.length - 1) {
        card.classList.add("left-1");
      } else {
        card.classList.add("hidden");
      }
    });

    dots.forEach((dot, i) => {
      dot.classList.toggle("active", i === currentIndex);
    });

    setTimeout(() => {
      isAnimating = false;
    }, 800);
  }

  leftArrow.addEventListener("click", () => {
    updateCarousel(currentIndex - 1);
  });

  rightArrow.addEventListener("click", () => {
    updateCarousel(currentIndex + 1);
  });

  cards.forEach((card, i) => {
    card.addEventListener("click", () => {
      updateCarousel(i);
    });
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") {
      updateCarousel(currentIndex - 1);
    } else if (e.key === "ArrowRight") {
      updateCarousel(currentIndex + 1);
    }
  });

  let touchStartX = 0;
  let touchEndX = 0;

  document.addEventListener("touchstart", (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });

  document.addEventListener("touchend", (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });

  function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        updateCarousel(currentIndex + 1);
      } else {
        updateCarousel(currentIndex - 1);
      }
    }
  }

  updateCarousel(0);

  // Mobile carousel
  const leftArrowMobile = document.querySelector(".nav-arrow-mobile.left");
  const rightArrowMobile = document.querySelector(".nav-arrow-mobile.right");

  leftArrowMobile.addEventListener("click", () => {
    plusSlides(-1);
  });

  rightArrowMobile.addEventListener("click", () => {
    plusSlides(1);
  });

  let slideIndex = 1;
  showSlides(slideIndex);

  // Next/previous controls
  function plusSlides(n) {
    showSlides((slideIndex += n));
  }

  // Thumbnail image controls
  function currentSlide(n) {
    showSlides((slideIndex = n));
  }

  function showSlides(n) {
    let i;
    let slides = document.getElementsByClassName("card-mobile");
    if (n > slides.length) {
      slideIndex = 1;
    }
    if (n < 1) {
      slideIndex = slides.length;
    }
    for (i = 0; i < slides.length; i++) {
      slides[i].style.display = "none";
    }
    slides[slideIndex - 1].style.display = "block";
  }

  // Add to cart functionality
  const addToCartButtons = document.querySelectorAll(
    ".product-details-add-to-cart"
  );
  addToCartButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const productCode = button.getAttribute("data-product-code");
      const csrfToken = button.getAttribute("data-csrf");
      addToCart(productCode, csrfToken);
      window.location.href = "/cart/summary";
    });
  });
</script>
{% endblock %}
